<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jawsome Matt Venture</title>
  <style>
    html, body { height: 100%; margin: 0; background:#92d4ff; font-family: system-ui, sans-serif; overflow:hidden; }
    #game { display:block; width:100vw; height:100vh; }

    /* Touch controls */
    #touch {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
    }
    #joystick {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.5);
      border-radius: 50%;
      pointer-events: auto;
      touch-action: none;
    }
    #stick {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      position: absolute;
      left: 25px;
      top: 25px;
      transition: transform 0.05s linear;
    }
    #btnJump {
      position: absolute;
      bottom: 30px;
      right: 30px;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
      background: #ffffffcc;
      font-size: 24px;
      pointer-events: auto;
    }
    @media (hover: hover) { #touch { display: none; } }

    /* Start Screen */
    #startScreen {
      position: fixed; inset: 0;
      background: #92d4ff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.8s ease;
      z-index: 10;
    }
    #startScreen img {
      max-width: 90%;
      max-height: 80vh;
      cursor: pointer;
    }
    #startScreen.hidden { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <!-- Touch controls -->
  <div id="touch" aria-hidden="true">
    <div id="joystick"><div id="stick"></div></div>
    <button id="btnJump">â¤’</button>
  </div>

  <!-- Start Screen -->
  <div id="startScreen">
    <img id="startImage" src="assets/matt-loading.png" alt="Loading...">
  </div>

  <script>
  // ================= Canvas =================
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  function resize(){ cvs.width = innerWidth; cvs.height = innerHeight; }
  addEventListener('resize', resize); resize();

  // ================= Assets =================
  const SPRITES = { idle:null, run:null, duck:null };
  async function loadImage(url){
    const img = new Image(); img.decoding = 'async'; img.src = url; await img.decode(); return img;
  }
  async function ensureSprites(){
    SPRITES.idle = await loadImage('assets/shark-idle.png').catch(()=>null);
    SPRITES.run  = await loadImage('assets/shark-running.png').catch(()=>null);
    SPRITES.duck = await loadImage('assets/shark-ducking.png').catch(()=>null);
    for (const k of ['idle','run','duck']) if (!SPRITES[k]) SPRITES[k] = genFallback(k);
  }
  function genFallback(kind){
    const c=document.createElement('canvas'); c.width=64; c.height=96; const g=c.getContext('2d');
    g.fillStyle = kind==='idle'?'#556': kind==='run'?'#5a86ff':'#ff6a6a';
    g.fillRect(0,0,c.width,c.height); g.fillStyle='white'; g.font='12px system-ui'; g.fillText(kind,6,16);
    return c;
  }

  // ================= Controls =================
  const keys = { left:false, right:false, up:false, jump:false, down:false, restart:false, next:false };
  addEventListener('keydown', e=>{
    if (['ArrowLeft','KeyA'].includes(e.code))  keys.left=true;
    if (['ArrowRight','KeyD'].includes(e.code)) keys.right=true;
    if (['ArrowUp','Space','KeyW'].includes(e.code)) keys.up=true, keys.jump=true;
    if (['ArrowDown','KeyS'].includes(e.code)) keys.down=true;
    if (e.code==='KeyR') keys.restart=true;
    if (e.code==='KeyL') keys.next=true;
  });
  addEventListener('keyup', e=>{
    if (['ArrowLeft','KeyA'].includes(e.code))  keys.left=false;
    if (['ArrowRight','KeyD'].includes(e.code)) keys.right=false;
    if (['ArrowUp','Space','KeyW'].includes(e.code)) keys.up=false;
    if (['ArrowDown','KeyS'].includes(e.code)) keys.down=false;
    if (e.code==='KeyR') keys.restart=false;
    if (e.code==='KeyL') keys.next=false;
  });

  // ================= Touch Joystick & Jump =================
  const joystick = document.getElementById('joystick');
  const stick = document.getElementById('stick');
  let joyCenter = { x: 0, y: 0 };
  let joyActive = false;

  joystick.addEventListener('pointerdown', e => {
    joyActive = true;
    joyCenter = { x: e.clientX, y: e.clientY };
  });
  joystick.addEventListener('pointermove', e => {
    if (!joyActive) return;
    const dx = e.clientX - joyCenter.x;
    const distance = Math.min(40, Math.abs(dx));
    stick.style.transform = `translateX(${dx > 0 ? distance : -distance}px)`;

    keys.left = dx < -10;
    keys.right = dx > 10;
  });
  joystick.addEventListener('pointerup', () => {
    joyActive = false;
    stick.style.transform = 'translateX(0px)';
    keys.left = false;
    keys.right = false;
  });
  joystick.addEventListener('pointercancel', () => {
    joyActive = false;
    stick.style.transform = 'translateX(0px)';
    keys.left = false;
    keys.right = false;
  });

  document.getElementById('btnJump').addEventListener('pointerdown', e => {
    e.preventDefault();
    keys.up = true;
    keys.jump = true;
  });
  document.getElementById('btnJump').addEventListener('pointerup', e => {
    e.preventDefault();
    keys.up = false;
  });

  // ================= Physics & Player =================
  const G = 2000, MAX_DX = 360, JUMP_VY = 700, accel = 1800;
  const player = { x:80, y:0, w:48, h:72, dx:0, dy:0, onGround:false, facing:1, animTime:0, state:'idle' };

  const levels = [
    { platforms:[ {x:-200,y:420,w:800,h:40}, {x:700,y:420,w:600,h:40}, {x:1400,y:420,w:600,h:40}, {x:560,y:340,w:160,h:20}, {x:1040,y:320,w:160,h:20}, {x:1680,y:300,w:160,h:20} ], goal:{x:1950,y:320,w:30,h:140}, hazards:[] },
    { platforms:[ {x:-200,y:420,w:500,h:40}, {x:450,y:420,w:280,h:40}, {x:860,y:420,w:260,h:40}, {x:1240,y:420,w:300,h:40}, {x:1580,y:420,w:420,h:40}, {x:2050,y:360,w:180,h:20} ], goal:{x:2280,y:280,w:30,h:140}, hazards:[ {x:760,y:402,w:60,h:18}, {x:1140,y:402,w:60,h:18} ] },
    { platforms:[ {x:-240,y:420,w:600,h:40}, {x:540,y:360,w:160,h:20}, {x:820,y:300,w:160,h:20}, {x:1100,y:260,w:160,h:20}, {x:1380,y:300,w:160,h:20}, {x:1660,y:340,w:160,h:20}, {x:1940,y:380,w:300,h:40} ], goal:{x:2140,y:300,w:30,h:140}, hazards:[] },
    { platforms:[ {x:-200,y:420,w:2200,h:40} ], goal:{x:1980,y:280,w:30,h:140}, hazards:[ {x:300,y:402,w:80,h:18},{x:520,y:402,w:80,h:18},{x:740,y:402,w:80,h:18},{x:960,y:402,w:80,h:18},{x:1180,y:402,w:80,h:18},{x:1400,y:402,w:80,h:18},{x:1620,y:402,w:80,h:18} ] },
    { platforms:[ {x:-200,y:420,w:500,h:40}, {x:380,y:360,w:160,h:20}, {x:660,y:300,w:160,h:20}, {x:940,y:240,w:160,h:20}, {x:1220,y:300,w:160,h:20}, {x:1500,y:360,w:160,h:20}, {x:1780,y:420,w:600,h:40} ], goal:{x:2100,y:320,w:30,h:140}, hazards:[ {x:820,y:402,w:80,h:18}, {x:1260,y:402,w:80,h:18} ] }
  ];
  let levelIndex = 0;
  const cam = { x:0, y:0 };

  function loadLevel(i){
    levelIndex = (i+levels.length)%levels.length;
    const L = levels[levelIndex];
    player.x = L.platforms[0].x + 80;
    player.y = L.platforms[0].y - 5;
    player.dx=0; player.dy=0; player.onGround=false; player.state='idle';
    cam.x = 0; cam.y = 0;
    keys.left = keys.right = keys.up = keys.jump = keys.down = false;
  }
  function aabb(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

  function update(dt){
    if (keys.restart){ loadLevel(levelIndex); keys.restart=false; }
    if (keys.next){ loadLevel(levelIndex+1); keys.next=false; }

    if (keys.left)  { player.dx = Math.max(player.dx - accel*dt, -MAX_DX); player.facing = -1; }
    if (keys.right) { player.dx = Math.min(player.dx + accel*dt,  MAX_DX); player.facing =  1; }
    if (!keys.left && !keys.right) player.dx *= Math.pow(0.0001, dt);

    player.dy += G*dt;
    if (player.onGround && keys.jump){ player.dy = -JUMP_VY; player.onGround=false; }
    keys.jump = false;

    const crouching = keys.down && player.onGround;
    moveAndCollide(dt, levels[levelIndex].platforms);

    const pbox = { x: player.x- player.w/2, y: player.y- player.h, w: player.w, h: player.h };
    if (levels[levelIndex].hazards.some(h => aabb(pbox, h))) loadLevel(levelIndex);
    if (aabb(pbox, levels[levelIndex].goal)) loadLevel(levelIndex+1);

    if (player.y > cvs.height + 600) loadLevel(levelIndex);

    const targetX = player.x - cvs.width*0.35; cam.x += (targetX - cam.x) * Math.min(1, dt*5);

    if (crouching) player.state = 'duck';
    else if (!player.onGround) player.state = 'air';
    else if (Math.abs(player.dx) > 40) player.state = 'run';
    else player.state = 'idle';
    player.animTime += dt;
  }
  function moveAndCollide(dt, solids){
    player.x += player.dx * dt; collideAxis('x', solids);
    player.y += player.dy * dt; player.onGround = false; collideAxis('y', solids);
  }
  function collideAxis(axis, solids){
    const box = { x: player.x- player.w/2, y: player.y- player.h, w: player.w, h: player.h };
    for (const s of solids){
      if (!aabb(box, s)) continue;
      if (axis==='x'){
        if (player.dx>0){ box.x = s.x - box.w; player.x = box.x + player.w/2; player.dx = 0; }
        else if (player.dx<0){ box.x = s.x + s.w; player.x = box.x + player.w/2; player.dx = 0; }
      } else {
        if (player.dy>0){ box.y = s.y - box.h; player.y = box.y + player.h; player.dy = 0; player.onGround = true; }
        else if (player.dy<0){ box.y = s.y + s.h; player.y = box.y + player.h; player.dy = 0; }
      }
    }
  }

  function draw(){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    const grd = ctx.createLinearGradient(0,0,0,cvs.height); grd.addColorStop(0,'#aee2ff'); grd.addColorStop(1,'#d9f4ff'); ctx.fillStyle = grd; ctx.fillRect(0,0,cvs.width,cvs.height);

    ctx.save(); ctx.translate(-cam.x, 0);
    const L = levels[levelIndex];
    for (const p of L.platforms){ ctx.fillStyle = '#75c46a'; ctx.fillRect(p.x, p.y, p.w, p.h); ctx.fillStyle='#4a8f42'; ctx.fillRect(p.x, p.y+ p.h-6, p.w, 6); }
    for (const s of L.hazards){ drawSpikeStrip(s.x, s.y, s.w, s.h); }

    const g = L.goal; ctx.fillStyle = '#ffcc00'; ctx.fillRect(g.x, g.y, 6, g.h);
    ctx.fillStyle = '#ff5d5d'; ctx.beginPath(); ctx.moveTo(g.x+6, g.y+8); ctx.lineTo(g.x+6+36, g.y+18); ctx.lineTo(g.x+6, g.y+28); ctx.closePath(); ctx.fill();

    drawPlayerSprite(player.x, player.y, player.facing, player.state);
    ctx.restore();
  }
  function drawSpikeStrip(x,y,w,h){
    const n = Math.max(1, Math.floor(w/12));
    for(let i=0;i<n;i++){
      const sx = x + i*(w/n); ctx.fillStyle = '#e04a4a'; ctx.beginPath(); ctx.moveTo(sx, y+h); ctx.lineTo(sx + (w/n)/2, y); ctx.lineTo(sx + (w/n), y+h); ctx.closePath(); ctx.fill();
    }
  }
  function drawPlayerSprite(px, py, facing, state){
    let img = SPRITES.idle;
    if (state==='run' || state==='air') img = SPRITES.run;
    else if (state==='duck') img = SPRITES.duck;
    const fw = img.naturalWidth || img.width;
    const fh = img.naturalHeight || img.height;
    ctx.save(); ctx.translate(px, py); ctx.scale(facing, 1); ctx.translate(-fw/2, -fh); ctx.imageSmoothingEnabled = false; ctx.drawImage(img, 0, 0); ctx.restore();
  }

  let lastTs;
  async function boot(){
    await ensureSprites();
    loadLevel(0);
    requestAnimationFrame(loop);
  }
  function loop(ts){ const dt = Math.min(1/30, (ts-(lastTs||ts))/1000); lastTs = ts; update(dt); draw(); requestAnimationFrame(loop); }

  document.getElementById('startImage').addEventListener('click', ()=>{
    document.getElementById('startScreen').classList.add('hidden');
    setTimeout(boot, 800);
  });
  </script>
</body>
</html>
